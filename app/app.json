{
    "_readme": [
      "The AMI used is generated by the packer template base/base.json",
      ""
    ],
    "variables": {
      "ami_name": "app",
      "ami_sha": "{{env `SHA`}}",
      "aws_access_key": "{{env `AWS_ACCESS_KEY`}}",
      "aws_secret_key": "{{env `AWS_SECRET_ACCESS_KEY`}}"
    },
    "builders": [
      {
        "ami_description": "{{user `ami_name`}} AMI",
        "ami_name": "{{user `ami_name`}} {{timestamp}}",
        "ami_regions": [
          "eu-west-1"
        ],
        "instance_type": "t1.micro",
        "region": "eu-west-1",
        "run_tags": {
          "ami-create": "{{user `ami_name`}}"
        },
  "source_ami_filter": {
     "filters": {
       "virtualization-type": "hvm",
       "architecture": "x86_64",
       "name": "*baseline-ubuntu-1604*",
       "block-device-mapping.volume-type": "gp2",
       "root-device-type": "ebs"
     },
     "owners": ["328062375629"],
     "most_recent": true
},
        "ssh_username": "ubuntu",
        "subnet_id": "",
        "tags": {
          "OS_Name": "Ubuntu",
          "OS_Version": "16.04",
          "SHA": "{{user `ami_sha`}}",
          "AMI": "{{user `ami_name`}}"
        },
        "type": "amazon-ebs",
        "vpc_id": ""
      }
    ],
    "post-processors": [
      {
        "output": "manifest-app.json",
        "strip_path": true,
        "type": "manifest"
      }
    ],
    "provisioners": [
      {
        "inline": [
          "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done"
        ],
        "type": "shell"
      },
      {
        "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E {{ .Path }}",
        "scripts": [
          "./app/tasks/apache.sh"
        ],
        "type": "shell"
      },
      {
        "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E {{ .Path }}",
        "scripts": [
          "./base/tasks/cleanup.sh",
          "./base/tasks/debug.sh"
        ],
        "type": "shell"
      }
    ]
  }
